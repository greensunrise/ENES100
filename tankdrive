#include <SoftwareSerial.h>
#include <dfr_tank.h>
#include "enes100.h"
DFRTank tank;

SoftwareSerial mySerial(8, 9); //RX is pin 8, TX is pin 9
enes100::RfClient<SoftwareSerial> rf(&mySerial); 
enes100::Marker marker;
int markerNumber=16; //update this with whatever black and white marker you receive

void getpos() {
  while (!rf.receiveMarker(&marker, 16)) { //If it failed...
    rf.sendMessage("It failedto get position.");
  }
 rf.sendMessage("\nGot my position.\n");
  
}

void die() {
  while(true) { //Wait forever
      tank.setLeftMotorPWM(0); tank.setRightMotorPWM(0);
      rf.sendMessage("Splashdown!"); //I did it
      delay(30000);
    }
  }
void orient() {
  getpos();
  float dx = (2.91 - marker.x); float dy = (.37 - marker.y); //Figure out distances from position
  float thetareq = atan2(dy,dx); //Figure out required angle
  rf.sendMessage("\n");
  rf.sendMessage("Got into orient code.");
  float dtheta = thetareq - marker.theta;
    while (dtheta < .2) {
      getpos(); 
      tank.setLeftMotorPWM(-250); tank.setRightMotorPWM(250);
      delay(100); //Change this later? Only turns for .1 sec. 
      tank.setLeftMotorPWM(0); tank.setRightMotorPWM(0);
      getpos();
      float dtheta = thetareq - marker.theta;
    while(dtheta > .2) {
      getpos(); 
      tank.setLeftMotorPWM(250); tank.setRightMotorPWM(-250);
      delay(100); //Change this later? Only turns for .1 sec. 
      tank.setLeftMotorPWM(0); tank.setRightMotorPWM(0);
      getpos();
      float dtheta = thetareq - marker.theta;
    }
  }
   rf.sendMessage("marker.theta is"); rf.sendMessage(marker.theta); 
   rf.sendMessage("thetareq is"); rf.sendMessage(thetareq); //Tell RF the current angle and the needed angle.
}

void setup()
{
  mySerial.begin(9600); //this establishes serial communication with
                        //something other than serial monitor, in this
                        //case RF communication with mission control
  Serial.begin(9600); //this establishes regular serial communication
                      //through USB to student's serial monitor

  pinMode(8, INPUT); //since pin 8 is RX, it receives as an input
  pinMode(9, OUTPUT); //since pin 9 is TX, it transmits as an output
  
  rf.resetServer();
  rf.sendMessage("\nWetWare is Connected\n"); //sent to mission control
  Serial.println("Wetware is Connected"); //sent to student's serial monitor
  tank.init();
  getpos();
  orient();
}

void loop() {
  getpos();
  float dx = 3.100 - marker.x; float dy = 3.100 - marker.y; //Figure out distances from position
  float distance = sqrt(sq(dx) + sq(dy)); //Gets distance from target.
  if (distance < .15) { //If we have arrived...
    die(); //heh
  }
  tank.setLeftMotorPWM(200); tank.setRightMotorPWM(200); //Go west, young man
  delay(1000);
  tank.setLeftMotorPWM(0); tank.setRightMotorPWM(0);
  orient();
}
